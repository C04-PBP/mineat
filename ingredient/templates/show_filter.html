{% extends 'base.html' %}
{% load static %}
{% block meta %}
<title>Filter</title>
<style>
    .dropdown-container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: flex-start;
        padding: 20px;
    }

    .ingredient-div.selected {
        background-color: #f0ad4e;
        border: 2px solid #000;
    }

    /* Sidebar Transition */
    #sidebar {
        transition: transform 0.3s ease-in-out;
    }

    #sidebar.collapsed {
        transform: translateX(-100%);
    }

    .content-wrapper {
        margin-top: 64px;
    }

    .add-fnb-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #BB0000;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: background-color 0.3s ease;
    }

    .add-fnb-button:hover {
        background-color: #ff0000;
    }

    /* Search icon button styling */
    .search-container {
        position: relative;
    }

    .search-icon {
        display: inline-block;
        cursor: pointer;
        transition: width 0.3s ease;
    }

    .search-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 0;
        opacity: 0;
        padding: 0;
        transition: width 0.3s ease, opacity 0.3s ease;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 5px 10px;
    }

    .search-container:hover .search-input {
        width: 200px;
        opacity: 1;
        padding: 5px 10px;
    }
</style>
{% endblock meta %}

{% block content %}
<header class="fixed top-0 left-0 right-0 z-20 bg-white shadow-lg">
    {% include "show_header.html" %}
    <!-- Search Bar -->
    <!-- <div class="flex items-center gap-4 justify-center mt-4">
        <div class="search-container">
            <svg class="search-icon w-6 h-6 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M8.5 14a5.5 5.5 0 100-11 5.5 5.5 0 000 11z" />
            </svg>
            <input type="text" id="filter-search-bar" placeholder="Search Fnbs..." class="search-input" />
        </div>
    </div> -->
</header>

<div class="flex flex-row gap-4 content-wrapper">
    <aside id="sidebar" class="transition-transform transform translate-x-0 w-[20vw] bg-[#ffee9e] relative dropdown-container">
        <div class="ingredient-div w-full h-[100vh] rounded-[20px] shadow overflow-auto">
            {% for ingredient in ingredients %}
            <div class="lazy-load ingredient-card" data-name="{{ ingredient.name }}">
                {% include "ingredient_card.html" with ingredient=ingredient %}
            </div>
            {% endfor %}
        </div>
    </aside>

    <!-- Content Section -->
    <div id="result" class="flex-1">{% include "fnb_kosong.html" with fnbs=fnb %}</div>
</div>

<a href="{% url 'fnb:add_fnb' %}" class="add-fnb-button">Add Fnb</a>

<script src="{% static 'js/fnb_card.js' %}"></script>

<script>
    // Sidebar toggle functionality
    const sidebar = document.getElementById('sidebar');
    const filterToggle = document.getElementById('filterToggle'); 

    filterToggle.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
    });

    // AJAX Search for Fnbs
    document.getElementById('filter-search-bar').addEventListener('input', function() {
        const query = this.value;

        if (query.trim() !== '') {
            fetch(`{% url 'fnb:search_fnbs' %}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('result').innerHTML = data.html;
                })
                .catch(error => console.error('Error with search:', error));
        } else {
            document.getElementById('result').innerHTML = '';  // Clear results if query is empty
        }
    });

    // Ingredient selection logic
    let selectedIngredients = [];
    document.querySelectorAll('.ingredient-card').forEach(div => {
        div.addEventListener('click', function () {
            const ingredient = div.getAttribute('data-name');
            if (!div.classList.contains('selected')) {
                div.classList.add('selected');
                selectedIngredients.push(ingredient);
            } else {
                selectedIngredients = selectedIngredients.filter(i => i !== ingredient);
                div.classList.remove('selected');
            }
            sendSelectedIngredients(selectedIngredients);
        });
    });

    function sendSelectedIngredients(selectedIngredients) {
        fetch('{% url "ingredient:record_ingredients" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({ ingredients: selectedIngredients })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('result').innerHTML = data.html;
        })
        .catch(error => console.error("Error recording ingredients:", error));
    }
</script>

{% endblock content %}
